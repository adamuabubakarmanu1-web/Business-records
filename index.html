<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Baseness Records — Dashboard</title>

  <!-- jsPDF (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #f4f7fb;
      --card: #ffffff;
      --accent: #2563eb;
      --accent2: #7b2ff7;
      --muted: #6b7280;
      --shadow: 0 8px 26px rgba(15,23,42,0.06);
      --radius: 12px;
      --text: #0f172a;
      --border: #e6edf5;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    
    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --accent: #3b82f6;
      --accent2: #8b5cf6;
      --muted: #94a3b8;
      --shadow: 0 8px 26px rgba(0,0,0,0.3);
      --text: #f1f5f9;
      --border: #334155;
    }
    
    [data-theme="midnight"] {
      --bg: #0a0f1c;
      --card: #131b2e;
      --accent: #6366f1;
      --accent2: #a855f7;
      --muted: #8b9bb8;
      --shadow: 0 8px 26px rgba(0,0,0,0.5);
      --text: #e2e8f0;
      --border: #2d3748;
    }
    
    [data-theme="sunset"] {
      --bg: #fef7ed;
      --card: #ffffff;
      --accent: #f97316;
      --accent2: #ea580c;
      --muted: #9a3412;
      --shadow: 0 8px 26px rgba(249,115,22,0.1);
      --text: #431407;
      --border: #fed7aa;
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
    }
    
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    header.topbar {
      position: sticky;
      top: 0;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: white;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow);
      z-index: 100;
      width: 100%;
    }
    
    .brand {
      display: flex;
      gap: 2px;
      align-items: center;
    }
    
    .logo {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(90deg, #ff7a18, #7b2ff7);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .welcome {
      font-weight: 700;
    }
    
    main.container {
      max-width: 1200px;
      margin: 18px auto;
      padding: 0 18px;
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
    }
    
    /* Mobile-specific adjustments */
    @media (max-width: 980px) {
      main.container {
        grid-template-columns: 1fr;
      }
      .left-col {
        order: 2;
      }
      .sidebar {
        order: 1;
      }
    }

    @media (max-width: 768px) {
      header.topbar {
        padding: 10px 12px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .right-controls {
        width: 100%;
        justify-content: space-between;
        margin-top: 8px;
      }
      
      .theme-menu {
        width: 100%;
      }
      
      .theme-menu-btn {
        width: 100%;
        justify-content: space-between;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .right-controls .subtabs {
        width: 100%;
        justify-content: space-between;
      }
      
      .search-inline {
        width: 100%;
        flex-wrap: wrap;
      }
      
      .search-inline input {
        flex: 1;
        min-width: 150px;
      }
      
      .panel {
        padding: 12px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      main.container {
        margin: 12px auto;
        padding: 0 12px;
        gap: 12px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .theme-menu-btn {
        padding: 10px 14px;
      }
      
      .right-controls .subtabs {
        flex-wrap: wrap;
      }
      
      .right-controls .subtabs button {
        flex: 1;
        min-width: 120px;
        margin-bottom: 4px;
      }
      
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filters input, .filters select {
        margin-bottom: 8px;
      }
    }

    /* Adjust layout for mobile */
    @media (max-width: 768px) {
      .panel-content-grid {
        grid-template-columns: 1fr !important;
        gap: 12px;
      }
      
      .form-section, .records-section {
        width: 100%;
      }
    }

    .panel {
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    
    .sidebar .nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .nav button {
      padding: 12px 16px;
      border-radius: 10px;
      border: 0;
      background: transparent;
      text-align: left;
      cursor: pointer;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
    }
    
    .nav button:hover {
      background: rgba(0,0,0,0.05);
      transform: translateX(4px);
    }
    
    [data-theme="dark"] .nav button:hover,
    [data-theme="midnight"] .nav button:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .nav .active {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .subtabs {
      display: flex;
      gap: 8px;
      margin: 10px 0;
    }
    
    .subtabs button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      color: var(--text);
      transition: all 0.2s ease;
    }
    
    .subtabs button:hover {
      transform: translateY(-2px);
    }
    
    .subtabs .active {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .filters {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .filters input, .filters select, input[type="text"], input[type="number"], textarea {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      width: 100%;
    }
    
    .filters input:focus, .filters select:focus, input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn.primary {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: white;
      font-weight: 700;
    }
    
    .btn.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    .btn.success {
      background: var(--success);
      color: white;
    }
    
    .btn.warning {
      background: var(--warning);
      color: white;
    }
    
    .btn.danger {
      background: var(--danger);
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      border-radius: 8px;
      overflow: hidden;
    }
    
    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 14px;
      vertical-align: top;
    }
    
    th {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: white;
      font-weight: 700;
    }
    
    tr:hover {
      background: rgba(0,0,0,0.03);
    }
    
    [data-theme="dark"] tr:hover,
    [data-theme="midnight"] tr:hover {
      background: rgba(255,255,255,0.03);
    }
    
    .actions-col {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .summary {
      margin-top: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      background: #eef7ff;
      font-weight: 700;
      border-left: 4px solid var(--accent);
    }
    
    [data-theme="dark"] .summary,
    [data-theme="midnight"] .summary {
      background: #1e3a5f;
    }
    
    [data-theme="sunset"] .summary {
      background: #ffedd5;
    }
    
    .small-muted {
      font-size: 13px;
      color: var(--muted);
    }
    
    .muted {
      color: var(--muted);
    }
    
    .right-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .search-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .hidden {
      display: none;
    }
    
    .note {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* Enhanced Theme Menu */
    .theme-menu {
      position: relative;
      display: inline-block;
    }
    
    .theme-menu-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .theme-menu-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .theme-menu-content {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 8px;
      background: var(--card);
      min-width: 200px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      z-index: 1000;
      overflow: hidden;
    }
    
    .theme-menu.active .theme-menu-content {
      display: block;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .theme-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      cursor: pointer;
      color: var(--text);
      transition: all 0.2s ease;
    }
    
    .theme-option:hover {
      background: rgba(0,0,0,0.05);
    }
    
    [data-theme="dark"] .theme-option:hover,
    [data-theme="midnight"] .theme-option:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .theme-option.active {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: white;
    }
    
    .theme-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .theme-name {
      font-weight: 600;
      flex: 1;
    }
    
    .theme-check {
      width: 16px;
      height: 16px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .theme-option.active .theme-check {
      opacity: 1;
    }

    /* Enhanced UI Elements */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .card-title {
      font-weight: 800;
      font-size: 18px;
      margin: 0;
    }
    
    .card-subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    
    .stat-card {
      background: var(--card);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      border-left: 4px solid var(--accent);
      box-shadow: var(--shadow);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--accent);
      margin: 8px 0 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }
    
    /* Animation for alerts */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .alert {
      animation: slideIn 0.3s ease;
    }

    /* Important: show multiline exactly as typed */
    .prewrap {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    /* Icon styles */
    .icon {
      width: 18px;
      height: 18px;
    }
    
    /* Mobile table adjustments */
    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      th, td {
        padding: 8px 10px;
        font-size: 13px;
      }
      
      .actions-col {
        flex-direction: column;
        gap: 4px;
      }
      
      .actions-col .btn {
        padding: 6px 10px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="brand">
      <div class="logo">BR</div>
      <div>
        <div class="welcome">Baseness Records</div>
        <div class="small-muted" id="themeStatus">Light mode • Offline (LocalStorage)</div>
      </div>
    </div>

    <div class="right-controls">
      <div class="theme-menu" id="themeMenu">
        <button class="theme-menu-btn" id="themeMenuBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75zM6.166 5.106a.75.75 0 0 1 0 1.06 8.25 8.25 0 1 0 11.668 0 .75.75 0 1 1 1.06-1.06c3.808 3.807 3.808 9.98 0 13.788-3.807 3.808-9.98 3.808-13.788 0-3.808-3.807-3.808-9.98 0-13.788a.75.75 0 0 1 1.06 0z"/>
          </svg>
          Theme
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5z" clip-rule="evenodd"/>
          </svg>
        </button>
        <div class="theme-menu-content">
          <button class="theme-option active" data-theme="light">
            <div class="theme-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-12a.75.75 0 0 0 .75-.75V2a.75.75 0 0 0-1.5 0v2.25c0 .414.336.75.75.75zm0 15a.75.75 0 0 0-.75.75V22a.75.75 0 0 0 1.5 0v-2.25A.75.75 0 0 0 12 20zM4.222 5.222a.75.75 0 0 0 1.06 0l1.5-1.5a.75.75 0 0 0-1.06-1.06l-1.5 1.5a.75.75 0 0 0 0 1.06zm14.496 14.496a.75.75 0 0 0 1.06 0l1.5-1.5a.75.75 0 1 0-1.06-1.06l-1.5 1.5a.75.75 0 0 0 0 1.06zM2 12a.75.75 0 0 0 .75.75H5a.75.75 0 0 0 0-1.5H2.75A.75.75 0 0 0 2 12zm17 0a.75.75 0 0 0 .75-.75V9a.75.75 0 0 0-1.5 0v2.25c0 .414.336.75.75.75zM5.282 19.718a.75.75 0 0 0 0-1.06l-1.5-1.5a.75.75 0 0 0-1.06 1.06l1.5 1.5a.75.75 0 0 0 1.06 0zm14.496-14.496a.75.75 0 0 0 0-1.06l-1.5-1.5a.75.75 0 1 0-1.06 1.06l1.5 1.5a.75.75 0 0 0 1.06 0z"/>
              </svg>
            </div>
            <span class="theme-name">Light</span>
            <svg class="theme-check" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207z" clip-rule="evenodd"/>
            </svg>
          </button>
          <button class="theme-option" data-theme="dark">
            <div class="theme-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.38 2.019a7.5 7.5 0 1 0 10.6 10.6C21.54 13.41 17.52 11 12 11c-5.52 0-9.54 2.41-10.62 3.619a7.5 7.5 0 0 0 10.02-10.02z"/>
              </svg>
            </div>
            <span class="theme-name">Dark</span>
            <svg class="theme-check" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207z" clip-rule="evenodd"/>
            </svg>
          </button>
          <button class="theme-option" data-theme="midnight">
            <div class="theme-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M21.752 15.002A9.718 9.718 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998z"/>
              </svg>
            </div>
            <span class="theme-name">Midnight</span>
            <svg class="theme-check" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207z" clip-rule="evenodd"/>
            </svg>
          </button>
          <button class="theme-option" data-theme="sunset">
            <div class="theme-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75zM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0zM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59zM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75zM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591zM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18zM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59zM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12zM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591z"/>
              </svg>
            </div>
            <span class="theme-name">Sunset</span>
            <svg class="theme-check" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207z" clip-rule="evenodd"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="small-muted">Auto date on save • Use date filter to show specific day</div>
    </div>
  </header>

  <main class="container">
    <!-- SIDEBAR -->
    <aside class="left-col">
      <div class="panel sidebar">
        <div class="card-header">
          <div style="font-weight:800">Sections</div>
        </div>
        <div class="nav" role="tablist" aria-label="main sections">
          <button class="active" data-section="pos" id="tabPos">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.25 2.25a.75.75 0 0 0 0 1.5h1.386c.17 0 .318.114.362.278l2.558 9.592a3.752 3.752 0 0 0-2.806 3.63c0 .414.336.75.75.75h15.75a.75.75 0 0 0 0-1.5H5.378A2.25 2.25 0 0 1 7.5 15h11.218a.75.75 0 0 0 .674-.421 60.358 60.358 0 0 0 2.96-7.228.75.75 0 0 0-.525-.965A60.864 60.864 0 0 0 5.68 4.509l-.232-.867A1.875 1.875 0 0 0 3.636 2.25H2.25zM3.75 20.25a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0zM16.5 20.25a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0z"/>
            </svg>
            POS
          </button>
          <button data-section="loan" id="tabLoan">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 7.5a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5z"/>
              <path fill-rule="evenodd" d="M1.5 4.875C1.5 3.839 2.34 3 3.375 3h17.25c1.035 0 1.875.84 1.875 1.875v9.75c0 1.036-.84 1.875-1.875 1.875H3.375A1.875 1.875 0 0 1 1.5 14.625v-9.75zM8.25 9.75a3.75 3.75 0 1 1 7.5 0 3.75 3.75 0 0 1-7.5 0zM18.75 9a.75.75 0 0 0-.75.75v.008c0 .414.336.75.75.75h.008a.75.75 0 0 0 .75-.75V9.75a.75.75 0 0 0-.75-.75h-.008zM4.5 9.75A.75.75 0 0 1 5.25 9h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75V9.75z" clip-rule="evenodd"/>
              <path d="M2.25 18a.75.75 0 0 0 0 1.5c5.4 0 10.63.722 15.6 2.075 1.19.324 2.4-.558 2.4-1.82V18.75a.75.75 0 0 0-.75-.75H2.25z"/>
            </svg>
            Loan
          </button>
          <button data-section="stock" id="tabStock">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M7.502 6h7.128A3.375 3.375 0 0 1 18 9.375v9.375a3 3 0 0 0 3-3V6.108c0-1.505-1.125-2.811-2.664-2.94a48.972 48.972 0 0 0-.673-.05A3 3 0 0 0 15 1.5h-1.5a3 3 0 0 0-2.663 1.618c-.225.015-.45.032-.673.05C8.662 3.295 7.554 4.542 7.502 6zM13.5 3A1.5 1.5 0 0 0 12 4.5h4.5A1.5 1.5 0 0 0 15 3h-1.5z" clip-rule="evenodd"/>
              <path fill-rule="evenodd" d="M3 9.375C3 8.339 3.84 7.5 4.875 7.5h9.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V9.375zM6 12a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V12zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75zM6 15a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V15zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75zM6 18a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V18zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75z" clip-rule="evenodd"/>
            </svg>
            Stock
          </button>
        </div>

        <div style="height:12px"></div>

        <div class="form-group">
          <label for="filterDate">Date filter (optional)</label>
          <input type="date" id="filterDate" title="Filter by date (YYYY-MM-DD)">
        </div>

        <div style="height:12px"></div>

        <div style="font-weight:700;margin-bottom:6px">Quick actions</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn ghost" id="showPos">Show POS</button>
          <button class="btn ghost" id="showLoan">Show Loan</button>
          <button class="btn ghost" id="showStock">Show Stock</button>
          <button class="btn danger" id="clearAll" title="Clear all saved records">Clear all data</button>
        </div>

        <div style="height:12px"></div>
        <div class="note">Notes removed as requested — only records, totals and PDFs remain.</div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <section class="right-col">
      <!-- POS PANEL -->
      <div id="panelPos" class="panel">
        <div class="card-header">
          <div>
            <div class="card-title">POS</div>
            <div class="card-subtitle">Transfer & Withdraw</div>
          </div>
          <div class="right-controls">
            <div class="subtabs" role="tablist">
              <button class="btn ghost" id="posSubTransfer">Transfer</button>
              <button class="btn ghost active" id="posSubWithdraw">Withdraw</button>
            </div>
            <button class="btn primary" id="posDownloadAll">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75zm-9 13.5a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75z" clip-rule="evenodd"/>
              </svg>
              Download All PDF
            </button>
          </div>
        </div>

        <!-- POS forms & records -->
        <div class="panel-content-grid" style="margin-top:12px;display:grid;grid-template-columns:1fr 380px;gap:12px">
          <div class="panel form-section" style="padding:16px">
            <div id="posFormHeader" style="font-weight:700;margin-bottom:12px">New POS (Withdraw)</div>

            <div id="posWithdrawForm">
              <div class="form-group">
                <label for="pos_withdraw_name">Full name</label>
                <input id="pos_withdraw_name" placeholder="Name">
              </div>
              <div class="form-group">
                <label for="pos_withdraw_amount">Amount</label>
                <input id="pos_withdraw_amount" type="number" placeholder="Amount">
              </div>
            </div>

            <div id="posTransferForm" class="hidden">
              <div class="form-group">
                <label for="pos_transfer_name">Full name</label>
                <input id="pos_transfer_name" placeholder="Recipient name">
              </div>
              <div class="form-group">
                <label for="pos_transfer_bank">Bank name (for search)</label>
                <input id="pos_transfer_bank" placeholder="Bank (e.g., Opay)">
              </div>
              <div class="form-group">
                <label for="pos_transfer_amount">Amount</label>
                <input id="pos_transfer_amount" type="number" placeholder="Amount">
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:16px">
              <button class="btn primary" id="savePos">Save POS</button>
              <button class="btn ghost" id="clearPos">Clear</button>
            </div>
          </div>

          <div class="panel records-section" style="padding:16px">
            <div class="card-header">
              <div style="font-weight:700">POS Records</div>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="posSearchBank" placeholder="Search by bank name (transfers)" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
                <button class="btn ghost" id="posSearchBtn">Search</button>
                <button class="btn ghost" id="posSearchClear">Clear</button>
              </div>
            </div>

            <div id="posRecordsArea" style="margin-top:12px"></div>
            <div id="posSummary" class="summary hidden"></div>
          </div>
        </div>
      </div>

      <!-- LOAN PANEL -->
      <div id="panelLoan" class="panel hidden">
        <div class="card-header">
          <div>
            <div class="card-title">Loan</div>
            <div class="card-subtitle">Borrower records</div>
          </div>
          <div class="right-controls">
            <div class="search-inline">
              <input id="loanSearchInput" placeholder="Search borrower name..." />
              <button class="btn ghost" id="loanSearchBtn">Search</button>
              <button class="btn ghost" id="loanSearchClear">Clear</button>
            </div>
            <button class="btn primary" id="loanDownloadAll">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75zm-9 13.5a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75z" clip-rule="evenodd"/>
              </svg>
              Download All PDF
            </button>
            <button class="btn primary hidden" id="loanDownloadPerson">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0zM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695z" clip-rule="evenodd"/>
              </svg>
              Download PDF (person)
            </button>
          </div>
        </div>

        <div class="panel-content-grid" style="margin-top:12px;display:grid;grid-template-columns:1fr 380px;gap:12px">
          <div class="panel form-section" style="padding:16px">
            <div style="font-weight:700;margin-bottom:12px">New Loan</div>
            <div class="form-group">
              <label for="loan_name">Borrower name</label>
              <input id="loan_name" placeholder="Name">
            </div>
            <div class="form-group">
              <label for="loan_items">Items (describe)</label>
              <!-- fixed-height textarea (as requested) -->
              <textarea id="loan_items" style="min-height:100px;max-height:160px;overflow:auto"></textarea>
            </div>
            <div class="form-group">
              <label for="loan_total">Total amount</label>
              <input id="loan_total" type="number" placeholder="Total amount">
            </div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn primary" id="saveLoan">Save Loan</button>
              <button class="btn ghost" id="clearLoan">Clear</button>
            </div>
          </div>

          <div class="panel records-section" style="padding:16px">
            <div style="font-weight:700;margin-bottom:12px">Loan Records</div>
            <div id="loanRecordsArea" style="margin-top:8px"></div>
            <div id="loanSummary" class="summary hidden"></div>
          </div>
        </div>
      </div>

      <!-- STOCK PANEL -->
      <div id="panelStock" class="panel hidden">
        <div class="card-header">
          <div>
            <div class="card-title">Stock</div>
            <div class="card-subtitle">Items & quantities</div>
          </div>
          <div class="right-controls">
            <button class="btn primary" id="stockDownloadAll">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75zm-9 13.5a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75z" clip-rule="evenodd"/>
              </svg>
              Download All PDF
            </button>
          </div>
        </div>

        <div class="panel-content-grid" style="margin-top:12px;display=grid;grid-template-columns:1fr 380px;gap:12px">
          <div class="panel form-section" style="padding:16px">
            <div style="font-weight:700;margin-bottom:12px">Add item</div>
            <div class="form-group">
              <label for="stock_item_name">Item name</label>
              <input id="stock_item_name" placeholder="Item name">
            </div>
            <div class="form-group">
              <label for="stock_quantity">Quantity</label>
              <input id="stock_quantity" type="number" value="1" min="1">
            </div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn primary" id="saveStock">Add Item</button>
              <button class="btn ghost" id="clearStock">Clear</button>
            </div>
          </div>

          <div class="panel records-section" style="padding:16px">
            <div style="font-weight:700;margin-bottom:12px">Stock List</div>
            <div id="stockRecordsArea" style="margin-top:8px"></div>
            <div id="stockSummary" class="summary hidden"></div>
          </div>
        </div>
      </div>

    </section>
  </main>

<script>
/* -------------------------
  Enhanced Theme Menu Functionality
   ------------------------- */
function initThemeMenu() {
  const themeMenu = document.getElementById('themeMenu');
  const themeMenuBtn = document.getElementById('themeMenuBtn');
  const themeOptions = document.querySelectorAll('.theme-option');
  const themeStatus = document.getElementById('themeStatus');
  const savedTheme = localStorage.getItem('baseness-theme') || 'light';
  
  // Apply saved theme
  document.documentElement.setAttribute('data-theme', savedTheme);
  updateThemeOptions(savedTheme);
  updateThemeStatus(savedTheme);
  
  // Toggle theme menu
  themeMenuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    themeMenu.classList.toggle('active');
  });
  
  // Close theme menu when clicking outside
  document.addEventListener('click', () => {
    themeMenu.classList.remove('active');
  });
  
  // Add event listeners to theme options
  themeOptions.forEach(option => {
    option.addEventListener('click', () => {
      const theme = option.dataset.theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('baseness-theme', theme);
      updateThemeOptions(theme);
      updateThemeStatus(theme);
      themeMenu.classList.remove('active');
    });
  });
}

function updateThemeOptions(activeTheme) {
  document.querySelectorAll('.theme-option').forEach(option => {
    option.classList.toggle('active', option.dataset.theme === activeTheme);
  });
}

function updateThemeStatus(theme) {
  const themeStatus = document.getElementById('themeStatus');
  const themeNames = {
    'light': 'Light',
    'dark': 'Dark',
    'midnight': 'Midnight',
    'sunset': 'Sunset'
  };
  themeStatus.textContent = `${themeNames[theme]} mode • Offline (LocalStorage)`;
}

/* -------------------------
  LocalStorage keys & helpers
   ------------------------- */
const KEY_POS = 'baseness_pos_v3';
const KEY_LOAN = 'baseness_loan_v3';
const KEY_STOCK = 'baseness_stock_v3';
const KEY_COUNTER = 'baseness_counters_v3';

function _getCounters(){ try { return JSON.parse(localStorage.getItem(KEY_COUNTER) || '{}'); } catch(e){ return {}; } }
function _saveCounters(c){ localStorage.setItem(KEY_COUNTER, JSON.stringify(c)); }
function _nextId(kind){
  const c = _getCounters();
  c[kind] = (c[kind] || 0) + 1;
  _saveCounters(c);
  return c[kind];
}
function _get(k){ try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch(e){ return []; } }
function _set(k,arr){ localStorage.setItem(k, JSON.stringify(arr)); }

/* date helpers */
function isoNow(){ return new Date().toISOString(); }
function dateOnly(iso){ if(!iso) return ''; return new Date(iso).toISOString().slice(0,10); }
function nice(iso){ try { return new Date(iso).toLocaleString(); } catch(e){ return iso; } }

/* UI wiring */
document.addEventListener('DOMContentLoaded', ()=> {
  // Initialize theme menu
  initThemeMenu();
  
  // tabs
  const tabPos = document.getElementById('tabPos'), tabLoan = document.getElementById('tabLoan'), tabStock = document.getElementById('tabStock');
  function show(s){
    tabPos.classList.toggle('active', s==='pos'); tabLoan.classList.toggle('active', s==='loan'); tabStock.classList.toggle('active', s==='stock');
    document.getElementById('panelPos').classList.toggle('hidden', s!=='pos');
    document.getElementById('panelLoan').classList.toggle('hidden', s!=='loan');
    document.getElementById('panelStock').classList.toggle('hidden', s!=='stock');
  }
  tabPos.addEventListener('click', ()=> show('pos')); tabLoan.addEventListener('click', ()=> show('loan')); tabStock.addEventListener('click', ()=> show('stock'));
  document.getElementById('showPos').addEventListener('click', ()=> show('pos'));
  document.getElementById('showLoan').addEventListener('click', ()=> show('loan'));
  document.getElementById('showStock').addEventListener('click', ()=> show('stock'));

  // clear all
  document.getElementById('clearAll').addEventListener('click', ()=>{
    if (!confirm('Clear ALL saved records? This cannot be undone.')) return;
    localStorage.removeItem(KEY_POS); localStorage.removeItem(KEY_LOAN); localStorage.removeItem(KEY_STOCK); localStorage.removeItem(KEY_COUNTER);
    showAlert('All data cleared');
    refreshAll();
  });

  // POS subtabs
  const posTransferBtn = document.getElementById('posSubTransfer'), posWithdrawBtn = document.getElementById('posSubWithdraw');
  function setPosMode(mode){
    const tr = (mode==='transfer');
    document.getElementById('posTransferForm').classList.toggle('hidden', !tr);
    document.getElementById('posWithdrawForm').classList.toggle('hidden', tr);
    posTransferBtn.classList.toggle('active', tr);
    posWithdrawBtn.classList.toggle('active', !tr);
    document.getElementById('posFormHeader').textContent = tr ? 'New POS (Transfer)' : 'New POS (Withdraw)';
  }
  posTransferBtn.addEventListener('click', ()=> setPosMode('transfer'));
  posWithdrawBtn.addEventListener('click', ()=> setPosMode('withdraw'));
  setPosMode('withdraw');

  // save / clear forms
  document.getElementById('savePos').addEventListener('click', savePos);
  document.getElementById('clearPos').addEventListener('click', clearPos);
  document.getElementById('saveLoan').addEventListener('click', saveLoan);
  document.getElementById('clearLoan').addEventListener('click', clearLoan);
  document.getElementById('saveStock').addEventListener('click', saveStock);
  document.getElementById('clearStock').addEventListener('click', clearStock);

  // date filter reload
  document.getElementById('filterDate').addEventListener('change', refreshAll);


  // POS search by bank (only applies to transfers)
  document.getElementById('posSearchBtn').addEventListener('click', performPosBankSearch);
  document.getElementById('posSearchClear').addEventListener('click', ()=>{ document.getElementById('posSearchBank').value=''; refreshPos(); });
  
document.getElementById('posSearchBtn').addEventListener('click', performPosmodeSearch);
  document.getElementById('posSearchClear').addEventListener('click', ()=>{ document.getElementById('posSearchmode').value=''; refreshPos(); });
  // Loan search
  document.getElementById('loanSearchBtn').addEventListener('click', performLoanSearch);
  document.getElementById('loanSearchClear').addEventListener('click', ()=>{ document.getElementById('loanSearchInput').value=''; lastLoanSearch=null; document.getElementById('loanDownloadPerson').classList.add('hidden'); refreshLoan(); });

  // downloads
  document.getElementById('posDownloadAll').addEventListener('click', ()=> exportTablePdf('pos'));
  document.getElementById('loanDownloadAll').addEventListener('click', ()=> exportTablePdf('loan'));
  document.getElementById('stockDownloadAll').addEventListener('click', ()=> exportTablePdf('stock'));
  document.getElementById('loanDownloadPerson').addEventListener('click', downloadLoanPerson);

  // initial
  refreshAll();
});

/* Save functions */
function savePos(){
  const isTransfer = !document.getElementById('posTransferForm').classList.contains('hidden');
  let name = '', bank='', amount='';
  if (isTransfer){
    name = document.getElementById('pos_transfer_name').value.trim();
    bank = document.getElementById('pos_transfer_bank').value.trim();
    amount = document.getElementById('pos_transfer_amount').value.trim();
  } else {
    name = document.getElementById('pos_withdraw_name').value.trim();
    amount = document.getElementById('pos_withdraw_amount').value.trim();
  }
  if (!name || !amount || isNaN(amount) || Number(amount) <= 0){ showAlert('Enter valid name and amount'); return; }
  const arr = _get(KEY_POS);
  const id = _nextId('pos');
  const rec = { id, mode: isTransfer ? 'transfer' : 'withdraw', name, bank_name: bank||'', amount: Number(amount), created_at: isoNow() };
  arr.unshift(rec);
  _set(KEY_POS, arr);
  showAlert('POS saved');
  clearPos();
  refreshPos();
}

function saveLoan(){
  const name = document.getElementById('loan_name').value.trim();
  const items = document.getElementById('loan_items').value; // keep newlines as-is
  const total = document.getElementById('loan_total').value.trim();
  if (!name || !items || !total || isNaN(total) || Number(total)<=0){ showAlert('Fill loan fields correctly'); return; }
  const arr = _get(KEY_LOAN);
  const id = _nextId('loan');
  const rec = { id, name, items, total_amount: Number(total), created_at: isoNow() };
  arr.unshift(rec);
  _set(KEY_LOAN, arr);
  showAlert('Loan saved');
  clearLoan();
  refreshLoan();
}

function saveStock(){
  const item = document.getElementById('stock_item_name').value.trim();
  const qty = document.getElementById('stock_quantity').value.trim();
  if (!item || !qty || isNaN(qty) || Number(qty)<=0){ showAlert('Enter item and quantity'); return; }
  const arr = _get(KEY_STOCK);
  const id = _nextId('stock');
  const rec = { id, item_name: item, quantity: Number(qty), created_at: isoNow() };
  arr.unshift(rec);
  _set(KEY_STOCK, arr);
  showAlert('Stock saved');
  clearStock();
  refreshStock();
}

/* clear forms */
function clearPos(){
  document.getElementById('pos_withdraw_name').value=''; document.getElementById('pos_withdraw_amount').value='';
  document.getElementById('pos_transfer_name').value=''; document.getElementById('pos_transfer_bank').value=''; document.getElementById('pos_transfer_amount').value='';
}
function clearLoan(){ document.getElementById('loan_name').value=''; document.getElementById('loan_items').value=''; document.getElementById('loan_total').value=''; }
function clearStock(){ document.getElementById('stock_item_name').value=''; document.getElementById('stock_quantity').value='1'; }

/* refresh tables */
function refreshAll(){ refreshPos(); refreshLoan(); refreshStock(); lastLoanSearch=null; document.getElementById('loanDownloadPerson').classList.add('hidden'); }

/* apply date filter helper */
function applyDate(list){
  const d = document.getElementById('filterDate').value;
  if (!d) return list;
  return list.filter(x=> dateOnly(x.created_at) === d);
}

/* POS refresh & search */
function refreshPos(){
  const area = document.getElementById('posRecordsArea');
  let arr = _get(KEY_POS);
  arr = applyDate(arr);
  if (!arr.length){ area.innerHTML = '<div class="small-muted">No POS records</div>'; document.getElementById('posSummary').classList.add('hidden'); return; }
  let total = 0;
  let html = `<table><thead><tr><th>#</th><th>Mode</th><th>Name</th><th>Bank</th><th>Amount</th><th>Date</th><th>Action</th></tr></thead><tbody>`;
  arr.forEach(r=>{
    html += `<tr><td>${r.id}</td><td>${escapeHtml(r.mode)}</td><td class="prewrap">${escapeHtml(r.name)}</td><td class="prewrap">${escapeHtml(r.bank_name||'')}</td><td>₦${Number(r.amount).toLocaleString()}</td><td>${nice(r.created_at)}</td><td class="actions-col"><button class="btn ghost" data-act="del-pos" data-id="${r.id}">Delete</button></td></tr>`;
    total += Number(r.amount);
  });
  html += `</tbody></table>`;
  area.innerHTML = html;
  const s = document.getElementById('posSummary'); s.classList.remove('hidden'); s.innerHTML = `Visible total: ₦${Number(total).toLocaleString()}`;
  // attach deletes
  area.querySelectorAll('[data-act="del-pos"]').forEach(b=>{
    b.addEventListener('click', ()=> {
      if (!confirm('Delete this POS record?')) return;
      const id = Number(b.dataset.id);
      const newArr = _get(KEY_POS).filter(x=> x.id !== id);
      _set(KEY_POS, newArr);
      showAlert('Deleted');
      refreshPos();
    });
  });
}

/* POS bank search (transfers only) */
function performPosBankSearch(){
  const q = (document.getElementById('posSearchBank').value||'').trim().toLowerCase();
  if (!q){ showAlert('Enter bank name to search'); return; }
  let arr = _get(KEY_POS).filter(x=> x.mode==='transfer' && (x.bank_name||'').toLowerCase().includes(q));
  arr = applyDate(arr);
  const area = document.getElementById('posRecordsArea');
  if (!arr.length){ area.innerHTML = '<div class="small-muted">No transfer records for that bank</div>'; document.getElementById('posSummary').classList.add('hidden'); return; }
  let total = 0; let html = `<table><thead><tr><th>#</th><th>Mode</th><th>Name</th><th>Bank</th><th>Amount</th><th>Date</th><th>Action</th></tr></thead><tbody>`;
  arr.forEach(r=>{ html += `<tr><td>${r.id}</td><td>${escapeHtml(r.mode)}</td><td class="prewrap">${escapeHtml(r.name)}</td><td class="prewrap">${escapeHtml(r.bank_name||'')}</td><td>₦${Number(r.amount).toLocaleString()}</td><td>${nice(r.created_at)}</td><td class="actions-col"><button class="btn ghost" data-act="del-pos" data-id="${r.id}">Delete</button></td></tr>`; total += Number(r.amount); });
  html += `</tbody></table>`;
  area.innerHTML = html;
  const s = document.getElementById('posSummary'); s.classList.remove('hidden'); s.innerHTML = `Visible transfer total: ₦${Number(total).toLocaleString()}`;
  area.querySelectorAll('[data-act="del-pos"]').forEach(b=>{
    b.addEventListener('click', ()=> {
      if (!confirm('Delete this POS record?')) return;
      const id = Number(b.dataset.id);
      const newArr = _get(KEY_POS).filter(x=> x.id !== id);
      _set(KEY_POS, newArr);
      showAlert('Deleted');
      performPosBankSearch();
    });
  });
}

/* LOAN refresh & search */
let lastLoanSearch = null;
function refreshLoan(listOverride){
  const area = document.getElementById('loanRecordsArea');
  let arr = _get(KEY_LOAN);
  arr = applyDate(arr);
  if (Array.isArray(listOverride)) arr = listOverride;
  if (!arr.length){ area.innerHTML = '<div class="small-muted">No Loan records</div>'; document.getElementById('loanSummary').classList.add('hidden'); return; }
  let total = 0; let html = `<table><thead><tr><th>#</th><th>Name</th><th>Items</th><th>Total</th><th>Date</th><th>Action</th></tr></thead><tbody>`;
  arr.forEach(r=>{
    // show items with line breaks preserved
    const itemsHtml = escapeHtml(r.items).replace(/\r/g,'').replace(/\n/g,'<br>');
    html += `<tr><td>${r.id}</td><td class="prewrap">${escapeHtml(r.name)}</td><td class="prewrap">${itemsHtml}</td><td>₦${Number(r.total_amount).toLocaleString()}</td><td>${nice(r.created_at)}</td><td class="actions-col"><button class="btn ghost" data-act="del-loan" data-id="${r.id}">Delete</button></td></tr>`;
    total += Number(r.total_amount);
  });
  html += `</tbody></table>`;
  area.innerHTML = html;
  const s = document.getElementById('loanSummary'); s.classList.remove('hidden'); s.innerHTML = `Visible total: ₦${Number(total).toLocaleString()}`;
  // attach delete
  area.querySelectorAll('[data-act="del-loan"]').forEach(b=>{
    b.addEventListener('click', ()=> {
      if (!confirm('Delete this loan record?')) return;
      const id = Number(b.dataset.id);
      const newArr = _get(KEY_LOAN).filter(x=> x.id !== id);
      _set(KEY_LOAN, newArr);
      showAlert('Deleted');
      refreshLoan();
    });
  });
}

function performLoanSearch(){
  const q = (document.getElementById('loanSearchInput').value||'').trim().toLowerCase();
  if (!q){ showAlert('Enter name to search'); return; }
  const all = applyDate(_get(KEY_LOAN));
  const results = all.filter(r=> (r.name||'').toLowerCase().includes(q));
  lastLoanSearch = results;
  refreshLoan(results);
  const btn = document.getElementById('loanDownloadPerson');
  if (results.length) btn.classList.remove('hidden'); else btn.classList.add('hidden');
}

/* STOCK refresh */
function refreshStock(){
  const area = document.getElementById('stockRecordsArea');
  let arr = _get(KEY_STOCK);
  arr = applyDate(arr);
  if (!arr.length){ area.innerHTML = '<div class="small-muted">No stock items</div>'; document.getElementById('stockSummary').classList.add('hidden'); return; }
  let totalQty = 0; let html = `<table><thead><tr><th>#</th><th>Item</th><th>Qty</th><th>Date</th><th>Action</th></tr></thead><tbody>`;
  arr.forEach(r=>{ html += `<tr><td>${r.id}</td><td class="prewrap">${escapeHtml(r.item_name)}</td><td>${r.quantity}</td><td>${nice(r.created_at)}</td><td class="actions-col"><button class="btn ghost" data-act="del-stock" data-id="${r.id}">Delete</button></td></tr>`; totalQty += Number(r.quantity); });
  html += `</tbody></table>`;
  area.innerHTML = html;
  const s = document.getElementById('stockSummary'); s.classList.remove('hidden'); s.innerHTML = `Visible total quantity: ${Number(totalQty).toLocaleString()}`;
  area.querySelectorAll('[data-act="del-stock"]').forEach(b=>{
    b.addEventListener('click', ()=> {
      if (!confirm('Delete this stock item?')) return;
      const id = Number(b.dataset.id);
      const newArr = _get(KEY_STOCK).filter(x=> x.id !== id);
      _set(KEY_STOCK, newArr);
      showAlert('Deleted');
      refreshStock();
    });
  });
}

/* overall */
function refreshAll(){ refreshPos(); refreshLoan(); refreshStock(); }

/* -------------------------
   PDF export: produce table-like PDF matching visible table
   ------------------------- */
function exportTablePdf(type){
  let arr = [];
  if (type==='pos') arr = applyDate(_get(KEY_POS));
  if (type==='loan') arr = applyDate(_get(KEY_LOAN));
  if (type==='stock') arr = applyDate(_get(KEY_STOCK));
  // if loan search active, prefer lastLoanSearch
  if (type==='loan' && lastLoanSearch) arr = lastLoanSearch;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  const left = 40;
  doc.setFontSize(16);
  doc.text('Baseness Records', left, 40);
  doc.setFontSize(12);
  const dateFilter = document.getElementById('filterDate').value;
  doc.text(`${type.toUpperCase()} records ${dateFilter ? ('for ' + dateFilter) : '(all)'}`, left, 60);
  let y = 84;
  doc.setFontSize(10);

  if (!arr.length){
    doc.text('No records', left, y);
    doc.save(`${type}_records_${dateFilter || 'all'}.pdf`);
    return;
  }

  // Build headers and lines depending on type
  if (type==='pos'){
    // headers
    const headers = ['ID','Mode','Name','Bank','Amount','Date'];
    drawTableHeader(doc, headers, left, y);
    y += 18;
    let total = 0;
    arr.forEach((r, idx)=>{
      const row = [String(r.id), r.mode, r.name, r.bank_name||'', '₦'+Number(r.amount).toLocaleString(), dateOnly(r.created_at)];
      drawTableRowSingle(doc, row, left, y);
      y+=14;
      total += Number(r.amount);
      if (y>740){ doc.addPage(); y=40; }
    });
    if (y>720){ doc.addPage(); y=40; }
    doc.setFontSize(11); doc.text(`Total amount: ₦${Number(total).toLocaleString()}`, left, y+12);
  } else if (type==='loan'){
    const headers = ['ID','Name','Items','Total','Date'];
    drawTableHeader(doc, headers, left, y);
    y += 18;
    let total = 0;
    arr.forEach((r, idx)=>{
      // preserve real line breaks in items
      const items = String(r.items || '').replace(/\r/g,'').split('\n');
      // we will draw multi-line cells - determine height needed
      const nameLines = String(r.name || '').split('\n');
      const totalLines = 1;
      const dateLines = 1;
      const idLines = 1;
      const itemsLines = items.length || 1;
      const maxLines = Math.max(idLines, nameLines.length, itemsLines, totalLines, dateLines);
      // draw line-by-line inside columns
      const colWidths = calcColWidths(5);
      let x = left;
      doc.setFontSize(9);
      // ID
      doc.text(String(r.id), x, y);
      x += colWidths[0];
      // Name (single-line normally)
      doc.text(String(r.name), x, y);
      x += colWidths[1];
      // Items - multiple lines
      for (let i=0;i<maxLines;i++){
        const it = items[i] || '';
        doc.text(it, x, y + (i*12));
      }
      x += colWidths[2];
      // Total
      doc.text('₦'+Number(r.total_amount).toLocaleString(), x, y);
      x += colWidths[3];
      // Date
      doc.text(dateOnly(r.created_at), x, y);
      // advance y by lines used
      y += Math.max( (maxLines * 12), 14 );
      total += Number(r.total_amount);
      if (y>740){ doc.addPage(); y=40; }
    });
    if (y>720){ doc.addPage(); y=40; }
    doc.setFontSize(11); doc.text(`Total loan amount: ₦${Number(total).toLocaleString()}`, left, y+12);
  } else {
    const headers = ['ID','Item','Qty','Date'];
    drawTableHeader(doc, headers, left, y);
    y += 18;
    let totalQty = 0;
    arr.forEach((r, idx)=>{
      const row = [String(r.id), r.item_name, String(r.quantity), dateOnly(r.created_at)];
      drawTableRowSingle(doc, row, left, y);
      y+=14;
      totalQty += Number(r.quantity);
      if (y>740){ doc.addPage(); y=40; }
    });
    if (y>720){ doc.addPage(); y=40; }
    doc.setFontSize(11); doc.text(`Total quantity: ${Number(totalQty).toLocaleString()}`, left, y+12);
  }

  const filename = `${type}_records_${document.getElementById('filterDate').value || 'all'}.pdf`;
  doc.save(filename);
}

/* Draw simple table header and row helpers (keeps layout consistent) */
function drawTableHeader(doc, cols, left, y){
  doc.setFontSize(10);
  let x = left;
  const colWidths = calcColWidths(cols.length);
  cols.forEach((c, i)=>{
    doc.text(c, x, y);
    x += colWidths[i];
  });
  // underline
  doc.setLineWidth(0.4);
  doc.line(left, y+2, left + colWidths.reduce((a,b)=>a+b,0)-10, y+2);
}
function drawTableRowSingle(doc, cols, left, y){
  doc.setFontSize(9);
  let x = left;
  const colWidths = calcColWidths(cols.length);
  cols.forEach((c,i)=>{
    const text = String(c);
    // basic truncation for very long text to avoid overflow (but loan items handled separately)
    const clipped = text.length > 200 ? text.substring(0,200) + '...' : text;
    doc.text(clipped, x, y);
    x += colWidths[i];
  });
}
/* Simple column width strategy for A4 pt coordinates */
function calcColWidths(n){
  const total = 500;
  const base = Math.floor(total / n);
  const arr = new Array(n).fill(base);
  if (n>=3) arr[1] = Math.floor(base * 1.5); // make 2nd col slightly wider (name / items)
  if (n>=5) { arr[2] = Math.floor(base * 2); arr[1] = Math.floor(base * 1.2); } // loan tweak
  return arr;
}

/* Download loan person (from last search) */
function downloadLoanPerson(){
  if (!lastLoanSearch || !lastLoanSearch.length){ showAlert('No search results to download'); return; }
  const arr = lastLoanSearch;
  const personName = (arr[0].name || 'person').replace(/\s+/g,'_');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  const left = 40;
  doc.setFontSize(16); doc.text('Baseness Records', left, 40);
  doc.setFontSize(14); doc.text(`Loan Record — ${arr[0].name}`, left, 60);
  let y = 92;
  doc.setFontSize(10);
  drawTableHeader(doc, ['ID','Items','Total','Date'], left, y);
  y += 18;
  let total = 0;
  arr.forEach((r,idx)=>{
    const items = String(r.items || '').replace(/\r/g,'').split('\n');
    const maxLines = Math.max(1, items.length);
    const colWidths = calcColWidths(4);
    let x = left;
    doc.setFontSize(9);
    // ID
    doc.text(String(r.id), x, y);
    x += colWidths[0];
    // Items
    for (let i=0;i<maxLines;i++){
      doc.text(items[i] || '', x, y + (i*12));
    }
    x += colWidths[1];
    // Total
    doc.text('₦'+Number(r.total_amount).toLocaleString(), x, y);
    x += colWidths[2];
    // Date
    doc.text(dateOnly(r.created_at), x, y);
    y += Math.max( (maxLines * 12), 14 );
    total += Number(r.total_amount);
    if (y>740){ doc.addPage(); y=40; }
  });
  if (y>720){ doc.addPage(); y=40; }
  doc.setFontSize(12); doc.text(`Total for ${arr[0].name}: ₦${Number(total).toLocaleString()}`, left, y+12);
  const filename = `loan_${personName}_${document.getElementById('filterDate').value || new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(filename);
}

/* Helper: escape */
function escapeHtml(s){ if (s===null || s===undefined) return ''; return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }

/* Enhanced alert with animation */
function showAlert(msg, t=2000){
  const el = document.createElement('div');
  el.style.position = 'fixed';
  el.style.right = '18px';
  el.style.top = '18px';
  el.style.background = 'linear-gradient(90deg, var(--accent), var(--accent2))';
  el.style.color = 'white';
  el.style.padding = '12px 16px';
  el.style.borderRadius = '8px';
  el.style.zIndex = 9999;
  el.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  el.textContent = msg;
  el.classList.add('alert');
  document.body.appendChild(el);
  setTimeout(()=> {
    el.style.opacity = '0';
    el.style.transform = 'translateX(100%)';
    setTimeout(()=> el.remove(), 300);
  }, t);
}

/* initial render */
refreshAll();

</script>
</body>
</html>
